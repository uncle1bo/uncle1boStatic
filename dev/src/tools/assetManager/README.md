# 资源管理器 (Asset Manager)

## 1. 项目结构

```
assetManager/
├── assetManagerController.js # 控制器处理HTTP请求
├── assetManagerService.js    # 核心服务实现
├── routes.js                 # 路由定义
└── README.md                 # 说明文档
```

## 2. 功能介绍

资源管理器是一个集成了外部资源管理和重定向功能的综合工具，用于检测本地缺失的依赖资源、提供一键下载功能，以及管理外部资源的自动重定向规则。

### 已实现功能列表

#### 资源管理功能
- **缺失资源检测** - 扫描本地文件系统，检测缺失的依赖资源
- **资源依赖分析** - 分析资源间的依赖关系，确保下载顺序
- **一键批量下载** - 支持批量下载所有缺失资源
- **下载进度监控** - 实时显示下载进度和状态
- **完整性校验** - 下载后自动验证文件完整性
- **版本管理** - 支持资源版本检查和更新
- **路径映射管理** - 管理依赖源到本地路径的映射关系
- **下载历史记录** - 记录所有下载操作的历史
- **404资源记录** - 自动记录访问失败的资源请求

#### 重定向管理功能
- **自动重定向规则** - 处理外部资源的自动重定向
- **自定义规则管理** - 支持添加、删除自定义重定向规则
- **规则优先级管理** - 支持规则优先级排序
- **重定向日志记录** - 记录所有重定向操作
- **路径验证** - 验证重定向目标路径的有效性
- **统计信息** - 提供重定向规则和使用统计

## 3. 用户使用方法

### 访问资源管理器
1. 启动开发服务器
2. 访问 `http://localhost:3000/asset-manager`

### 资源管理操作流程
1. **扫描缺失资源** - 点击"扫描"按钮检测本地缺失的资源
2. **查看缺失列表** - 查看详细的缺失资源列表和依赖关系
3. **选择下载资源** - 可选择性下载特定资源或全部下载
4. **监控下载进度** - 实时查看下载进度和状态
5. **验证完整性** - 下载完成后自动进行完整性检查
6. **查看下载历史** - 查看历史下载记录和统计信息
7. **管理404资源** - 查看和处理404资源记录

### 重定向管理操作流程
1. **查看重定向规则** - 查看当前所有重定向规则
2. **添加自定义规则** - 创建新的重定向规则
3. **编辑现有规则** - 修改已有的重定向规则
4. **删除规则** - 移除不需要的重定向规则
5. **测试重定向** - 测试重定向规则的有效性
6. **查看统计信息** - 查看重定向使用统计

### 功能说明
- **智能检测** - 根据依赖配置自动检测本地缺失的资源文件
- **依赖解析** - 自动分析资源依赖关系，确保正确的下载顺序
- **多源下载** - 支持从多个依赖源下载，自动选择最快的源
- **断点续传** - 支持大文件的断点续传功能
- **完整性保证** - 使用SHA-256校验确保下载文件的完整性
- **版本同步** - 检查并同步资源的最新版本
- **自动重定向** - 智能处理资源路径重定向，确保资源正确加载
- **规则管理** - 灵活的重定向规则管理系统

## 4. API使用方法

### 资源管理API

```javascript
// 扫描缺失资源
GET /api/asset-manager/scan

// 下载资源
POST /api/asset-manager/download
{
  "resourceKey": "bootstrap-css",
  "force": false
}

// 批量下载
POST /api/asset-manager/download-batch
{
  "resources": ["bootstrap-css", "jquery"],
  "force": false
}

// 获取下载历史
GET /api/asset-manager/history

// 获取404资源记录
GET /api/asset-manager/404-resources

// 清理404资源记录
DELETE /api/asset-manager/404-resources
```

### 重定向管理API

```javascript
// 获取所有重定向规则
GET /api/asset-manager/redirect-rules

// 添加自定义重定向规则
POST /api/asset-manager/redirect-rules
{
  "name": "custom-rule",
  "pattern": "/old-path/(.*)",
  "redirect": "/new-path/$1",
  "description": "自定义重定向规则"
}

// 删除重定向规则
DELETE /api/asset-manager/redirect-rules/:ruleName

// 测试重定向
POST /api/asset-manager/test-redirect
{
  "path": "/test-path"
}

// 获取重定向统计
GET /api/asset-manager/redirect-stats

// 更新重定向配置
PUT /api/asset-manager/redirect-config
{
  "enabled": true,
  "logRedirects": true,
  "statusCode": 302
}
```

## 5. 注意事项

### 资源配置格式要求
**重要：必须使用 `path` 属性配置资源路径**

资源配置对象必须包含 `path` 属性来指定本地文件路径：

```javascript
// 正确的配置格式
'bootstrap-css': {
  type: 'css',
  path: 'assets/libs/bootstrap/bootstrap.min.css',  // 必须使用 path 属性
  integrity: null
}

// 注意：localPath 属性已完全废弃，不再支持
```

### 易犯错误
1. **资源配置格式错误** - 确保资源配置使用 `path` 属性，`localPath` 属性已完全废弃
2. **路径错误** - 确保资源文件路径正确，相对于项目根目录
3. **网络连接问题** - 确保网络连接正常，某些CDN可能需要代理
4. **权限问题** - 确保对目标目录有写入权限
5. **重定向循环** - 避免创建会导致循环重定向的规则
6. **规则冲突** - 注意自定义规则与内置规则的优先级

### 用户提出的规则
- 下载前先备份重要文件
- 定期清理下载历史和404记录
- 谨慎使用强制下载选项
- 重定向规则测试后再启用
- 注意CDN资源的版本兼容性
- **资源配置必须使用 `path` 属性，`localPath` 属性已完全废弃**
- 下载大文件时请保持网络连接稳定
- 重定向规则的正则表达式需要谨慎编写，避免冲突
- 自定义重定向规则会覆盖内置规则，请注意优先级
- 定期清理404资源记录以避免文件过大
- 建议在生产环境部署前测试所有重定向规则
- 资源下载完成后会自动验证文件完整性
- 支持断点续传，网络中断后可继续下载